(()=>{"use strict";function e(e,t){const o=t.cardTemplate.querySelector(".card").cloneNode("true"),r=o.querySelector(".card__image"),n=o.querySelector(".card__like-button"),s=o.querySelector(".card__like-counter");return r.src=e.link,r.alt=e.name,o.id=e._id,s.textContent=e.likes.length,o.querySelector(".card__title").textContent=e.name,t.profileId===e.owner._id?o.querySelector(".card__delete-button").addEventListener("click",(()=>{t.eraseCard(o.id)})):o.querySelector(".card__delete-button").classList.add("card__delete-button_disabled"),e.likes.some((e=>e._id===t.profileId))&&n.classList.add("card__like-button_is-active"),n.addEventListener("click",(e=>{t.checkLikeCard(e,o.id,s)})),r.addEventListener("click",t.openLargeImage),o}function t(e,t,o){Number(o)===o&&e.classList.toggle("card__like-button_is-active"),t.textContent=o}function o(e){e.classList.add("popup_is-animated"),setTimeout((e=>{e.classList.add("popup_is-opened")}),50,e),document.addEventListener("keydown",n)}function r(e){e.classList.remove("popup_is-opened"),setTimeout((e=>{e.classList.remove("popup_is-animated")}),600,e),document.removeEventListener("keydown",n)}function n(e){"Escape"===e.key&&r(document.querySelector(".popup_is-opened"))}function s(e,t,o){!function(e){return e.some((e=>!e.validity.valid))}(e)?t.classList.remove(o):t.classList.add(o)}function a(e,t){const o=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);let n;o.forEach((o=>{n=e.querySelector(`.popup__error_input-error_${o.id}`),o.classList.remove(t.inputErrorClass),n.classList.remove(t.errorClass),n.textContent=""})),r.classList.add(t.inactiveButtonClass)}const c={baseUrl:"https://mesto.nomoreparties.co/v1/wff-cohort-11",headers:{authorization:"34673cb7-5fe3-4323-9567-b98efa2f95b7","Content-Type":"application/json;charset=utf-8"}},i=document.querySelector(".places__list"),u=document.querySelector("#card-template").content,l=document.querySelectorAll(".popup"),d=document.querySelector(".popup_type_edit"),p=document.querySelector(".popup_type_new-card"),m=document.querySelector(".popup_type_image"),_=document.querySelector(".popup__image"),h=document.querySelector(".popup__caption"),y=document.querySelector(".popup_type_agree"),f=y.querySelector(".popup__button"),v=document.querySelector(".popup_type_new-avatar"),S=document.querySelector(".profile__title"),b=document.querySelector(".profile__description"),C=document.querySelector(".profile__image"),k=document.forms["edit-profile"],q=k.elements.name,L=k.elements.description,g=k.querySelector(".popup__button"),E=document.forms["new-place"],x=E.elements["place-name"],$=E.elements.link,j=E.querySelector(".popup__button"),T=document.forms["new-avatar"],P=T.elements["ava-link"],w=T.querySelector(".popup__button"),A={cardTemplate:u,profileId:"",openLargeImage:function(e){_.src=e.target.src,_.alt=e.target.alt,h.textContent=e.target.closest(".card").querySelector(".card__title").textContent,o(m)},checkLikeCard:function(e,o,r,n){const s=e.target;s.classList.contains("card__like-button_is-active")?(e=>fetch(`${c.baseUrl}/cards/likes/${e}`,{method:"DELETE",headers:c.headers}).then((e=>e.ok?e.json():Promise.reject(`❌ Ошибка стирания лайка. Код: ${e.status}`))))(o).then((e=>{n=e.likes.length})).catch((()=>{n="ERROR"})).finally((()=>{t(s,r,n)})):(e=>fetch(`${c.baseUrl}/cards/likes/${e}`,{method:"PUT",headers:c.headers}).then((e=>e.ok?e.json():Promise.reject(`❌ Ошибка записи лайка. Код: ${e.status}`))))(o).then((e=>{n=e.likes.length})).catch((()=>{n="ERROR"})).finally((()=>{t(s,r,n)}))},eraseCard:function(e){f.onclick=()=>{f.textContent="Удаление...",(e=>fetch(`${c.baseUrl}/cards/${e}`,{method:"DELETE",headers:c.headers}).then((e=>e.ok?e.json():Promise.reject(`❌ Ошибка удаления. Код: ${e.status}`))))(e).then((()=>{!function(e){document.getElementById(e).remove()}(e),r(y),setTimeout((e=>{e.textContent="Да"}),1e3,f)})).catch((e=>{B(e,f,"Да","Ошибка удаления")}))},o(y)}},U={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"};function B(e,t,o,r){"string"==typeof e&&e.startsWith("❌")||(e="❌ "+r),t.textContent=e,setTimeout((e=>{e.textContent=o}),5e3,t)}document.querySelector(".profile__edit-button").addEventListener("click",(()=>{q.value=S.textContent,L.value=b.textContent,a(k,U),o(d)})),document.querySelector(".profile__add-button").addEventListener("click",(()=>{o(p)})),document.querySelector(".profile__image").addEventListener("click",(()=>{o(v)})),l.forEach((e=>{e.addEventListener("mousedown",(t=>{t.target.classList.contains("popup_is-opened")&&r(e),t.target.classList.contains("popup__close")&&r(e)}))})),k.addEventListener("submit",(function(e){var t,o;e.preventDefault(),g.textContent="Сохранение...",(t=q.value,o=L.value,fetch(`${c.baseUrl}/users/me`,{method:"PATCH",headers:c.headers,body:JSON.stringify({name:t,about:o})}).then((e=>e.ok?e.json():Promise.reject(`❌ Ошибка отправки. Код: ${e.status}`)))).then((e=>{S.textContent=e.name,b.textContent=e.about,r(d),setTimeout((e=>{e.textContent="Сохранить"}),1e3,g)})).catch((e=>{B(e,g,"Сохранить","Ошибка отправки")}))})),E.addEventListener("submit",(function(t){var o,n;t.preventDefault(),j.textContent="Сохранение...",(o=x.value,n=$.value,fetch(`${c.baseUrl}/cards`,{method:"POST",headers:c.headers,body:JSON.stringify({name:o,link:n})}).then((e=>e.ok?e.json():Promise.reject(`❌ Ошибка отправки. Код: ${e.status}`)))).then((t=>{i.prepend(e(t,A)),r(p),setTimeout((e=>{e.textContent="Сохранить"}),1e3,j),E.reset(),a(E,U)})).catch((e=>{B(e,j,"Сохранить","Ошибка отправки")}))})),T.addEventListener("submit",(function(e){var t;e.preventDefault(),w.textContent="Сохранение...",(t=P.value,fetch(t,{method:"HEAD"}).then((e=>e.ok?!!e.headers.get("Content-Type").includes("image"):Promise.reject(`❌ Картинка недоступна. Код: ${e.status}`)))).then((e=>{if(!e)return Promise.reject("❌ По ссылке не картинка");(e=>fetch(`${c.baseUrl}/users/me/avatar`,{method:"PATCH",headers:c.headers,body:JSON.stringify({avatar:e})}).then((e=>e.ok?e.json():Promise.reject(`❌ Ошибка отправки. Код: ${e.status}`))))(P.value).then((e=>{C.style["background-image"]=`url(${e.avatar})`,r(v),setTimeout((e=>{e.textContent="Сохранить"}),1e3,w),T.reset(),a(T,U)}))})).catch((e=>{B(e,w,"Сохранить","Картинка недоступна или плохая")}))})),function(e){Array.from(document.querySelectorAll(e.formSelector)).forEach((t=>{!function(e,t){const o=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);s(o,r,t.inactiveButtonClass),o.forEach((n=>{n.addEventListener("input",(()=>{!function(e,t,o,r){t.validity.patternMismatch?t.setCustomValidity(t.dataset.errorMessage):t.setCustomValidity(""),t.validity.valid?function(e,t,o,r){const n=e.querySelector(`.popup__error_input-error_${t.id}`);t.classList.remove(o),n.classList.remove(r),n.textContent=""}(e,t,o,r):function(e,t,o,r,n){const s=e.querySelector(`.popup__error_input-error_${t.id}`);t.classList.add(o),s.textContent=n,s.classList.add(r)}(e,t,o,r,t.validationMessage)}(e,n,t.inputErrorClass,t.errorClass),s(o,r,t.inactiveButtonClass)}))}))}(t,e)}))}(U),Promise.all([fetch(`${c.baseUrl}/users/me`,{headers:c.headers}).then((e=>e.ok?e.json():Promise.reject(`❌ Ошибка получения профиля. Код: ${e.status}`))),fetch(`${c.baseUrl}/cards`,{headers:c.headers}).then((e=>e.ok?e.json():Promise.reject(`❌ Ошибка получения карточек. Код: ${e.status}`)))]).then((t=>{let[o,r]=t;S.textContent=o.name,b.textContent=o.about,C.style["background-image"]=`url(${o.avatar})`,A.profileId=o._id,r.forEach((t=>{i.append(e(t,A))}))})).catch((e=>{"string"==typeof e&&e.startsWith("❌")||(e="Ошибка начальной загрузки");const t=document.querySelector(".popup_type_error");t.querySelector(".popup__title").textContent=e,t.querySelector(".popup__button").addEventListener("click",(()=>{window.location.reload()})),o(t)}))})();