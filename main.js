(()=>{"use strict";function e(e,t){const r=t.cardTemplate.querySelector(".card").cloneNode("true"),o=r.querySelector(".card__image"),n=r.querySelector(".card__like-button"),a=r.querySelector(".card__like-counter");return o.src=e.link,o.alt=e.name,r.id=e._id,a.textContent=e.likes.length,r.querySelector(".card__title").textContent=e.name,t.profileId===e.owner._id?r.querySelector(".card__delete-button").addEventListener("click",(()=>{t.eraseCard(r.id)})):r.querySelector(".card__delete-button").classList.add("card__delete-button_disabled"),e.likes.some((e=>e._id===t.profileId))&&n.classList.add("card__like-button_is-active"),n.addEventListener("click",(e=>{t.checkLikeCard(e,r.id,a)})),o.addEventListener("click",t.openLargeImage),r}function t(e){e.classList.add("popup_is-animated"),setTimeout((()=>{e.classList.add("popup_is-opened")}),50),document.addEventListener("keydown",o)}function r(e){e.classList.remove("popup_is-opened"),setTimeout((()=>{e.classList.remove("popup_is-animated")}),600),document.removeEventListener("keydown",o)}function o(e){"Escape"===e.key&&r(document.querySelector(".popup_is-opened"))}function n(e,t,r){const o=function(e){return e.some((e=>!e.validity.valid))}(e);o?t.classList.add(r):t.classList.remove(r),t.disabled=o}function a(e,t,r,o){const n=e.querySelector(`.popup__error_input-error_${t.id}`);t.classList.remove(r),n.classList.remove(o),n.textContent=""}function s(e,t){const r=Array.from(e.querySelectorAll(t.inputSelector)),o=e.querySelector(t.submitButtonSelector);r.forEach((r=>{a(e,r,t.inputErrorClass,t.errorClass)})),o.classList.add(t.inactiveButtonClass)}const c={baseUrl:"https://mesto.nomoreparties.co/v1/wff-cohort-11",headers:{authorization:"34673cb7-5fe3-4323-9567-b98efa2f95b7","Content-Type":"application/json;charset=utf-8"}};function i(e,t){return e.ok?e.json():Promise.reject(t)}const u=e=>fetch(`${c.baseUrl}/cards/likes/${e}`,{method:"PUT",headers:c.headers}).then((e=>i(e,`❌ Ошибка записи лайка. Код: ${e.status}`))),l=e=>fetch(`${c.baseUrl}/cards/likes/${e}`,{method:"DELETE",headers:c.headers}).then((e=>i(e,`❌ Ошибка стирания лайка. Код: ${e.status}`))),d=document.querySelector(".places__list"),p=document.querySelector("#card-template").content,m=document.querySelectorAll(".popup"),_=document.querySelector(".popup_type_edit"),f=document.querySelector(".popup_type_new-card"),h=document.querySelector(".popup_type_image"),y=document.querySelector(".popup__image"),v=document.querySelector(".popup__caption"),S=document.querySelector(".popup_type_agree"),b=document.querySelector(".popup_type_new-avatar"),C=S.querySelector(".popup__button");let q;const L=document.querySelector(".profile__title"),g=document.querySelector(".profile__description"),k=document.querySelector(".profile__image"),E=document.forms["edit-profile"],x=E.elements.name,$=E.elements.description,T=E.querySelector(".popup__button"),w=document.forms["new-place"],A=w.elements["place-name"],U=w.elements.link,B=w.querySelector(".popup__button"),P=document.forms["new-avatar"],I=P.elements["ava-link"],D=P.querySelector(".popup__button"),j={cardTemplate:p,profileId:"",openLargeImage:function(e){y.src=e.target.src,y.alt=e.target.alt,v.textContent=e.target.closest(".card").querySelector(".card__title").textContent,t(h)},checkLikeCard:function(e,t,r,o){const n=e.target;(n.classList.contains("card__like-button_is-active")?l:u)(t).then((e=>{o=e.likes.length})).catch((()=>{o="ERROR"})).finally((()=>{!function(e,t,r){Number(r)===r&&e.classList.toggle("card__like-button_is-active"),t.textContent=r}(n,r,o)}))},eraseCard:function(e){q=e,t(S)}},N={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"};function O(e,t,r,o){"string"==typeof e&&e.startsWith("❌")||(e="❌ "+o),t.textContent=e,setTimeout((()=>{t.textContent=r}),5e3)}document.querySelector(".profile__edit-button").addEventListener("click",(()=>{x.value=L.textContent,$.value=g.textContent,s(E,N),t(_)})),document.querySelector(".profile__add-button").addEventListener("click",(()=>{t(f)})),document.querySelector(".profile__image").addEventListener("click",(()=>{t(b)})),m.forEach((e=>{e.addEventListener("mousedown",(t=>{(t.target.classList.contains("popup_is-opened")||t.target.classList.contains("popup__close"))&&r(e)}))})),E.addEventListener("submit",(function(e){var t,o;e.preventDefault(),T.textContent="Сохранение...",(t=x.value,o=$.value,fetch(`${c.baseUrl}/users/me`,{method:"PATCH",headers:c.headers,body:JSON.stringify({name:t,about:o})}).then((e=>i(e,`❌ Ошибка отправки. Код: ${e.status}`)))).then((e=>{L.textContent=e.name,g.textContent=e.about,r(_),setTimeout((()=>{T.textContent="Сохранить"}),1e3)})).catch((e=>{O(e,T,"Сохранить","Ошибка отправки")}))})),w.addEventListener("submit",(function(t){var o,n;t.preventDefault(),B.textContent="Сохранение...",(o=A.value,n=U.value,fetch(`${c.baseUrl}/cards`,{method:"POST",headers:c.headers,body:JSON.stringify({name:o,link:n})}).then((e=>i(e,`❌ Ошибка отправки. Код: ${e.status}`)))).then((t=>{d.prepend(e(t,j)),r(f),setTimeout((()=>{B.textContent="Сохранить"}),1e3),w.reset(),s(w,N)})).catch((e=>{O(e,B,"Сохранить","Ошибка отправки")}))})),P.addEventListener("submit",(function(e){var t;e.preventDefault(),D.textContent="Сохранение...",(t=I.value,fetch(t,{method:"HEAD"}).then((e=>e.ok?!!e.headers.get("Content-Type").includes("image"):Promise.reject(`❌ Картинка недоступна. Код: ${e.status}`)))).then((e=>{if(!e)return Promise.reject("❌ По ссылке не картинка");(e=>fetch(`${c.baseUrl}/users/me/avatar`,{method:"PATCH",headers:c.headers,body:JSON.stringify({avatar:e})}).then((e=>i(e,`❌ Ошибка отправки. Код: ${e.status}`))))(I.value).then((e=>{k.style["background-image"]=`url(${e.avatar})`,r(b),setTimeout((()=>{D.textContent="Сохранить"}),1e3),P.reset(),s(P,N)}))})).catch((e=>{O(e,D,"Сохранить","Картинка недоступна или плохая")}))})),C.addEventListener("click",(()=>{var e;C.textContent="Удаление...",(e=q,fetch(`${c.baseUrl}/cards/${e}`,{method:"DELETE",headers:c.headers}).then((e=>i(e,`❌ Ошибка удаления. Код: ${e.status}`)))).then((()=>{!function(e){document.getElementById(e).remove()}(q),r(S),setTimeout((()=>{C.textContent="Да"}),1e3)})).catch((e=>{O(e,C,"Да","Ошибка удаления")}))})),function(e){Array.from(document.querySelectorAll(e.formSelector)).forEach((t=>{!function(e,t){const r=Array.from(e.querySelectorAll(t.inputSelector)),o=e.querySelector(t.submitButtonSelector);n(r,o,t.inactiveButtonClass),r.forEach((s=>{s.addEventListener("input",(()=>{!function(e,t,r,o){t.validity.patternMismatch?t.setCustomValidity(t.dataset.errorMessage):t.setCustomValidity(""),t.validity.valid?a(e,t,r,o):function(e,t,r,o,n){const a=e.querySelector(`.popup__error_input-error_${t.id}`);t.classList.add(r),a.textContent=n,a.classList.add(o)}(e,t,r,o,t.validationMessage)}(e,s,t.inputErrorClass,t.errorClass),n(r,o,t.inactiveButtonClass)}))}))}(t,e)}))}(N),Promise.all([fetch(`${c.baseUrl}/users/me`,{headers:c.headers}).then((e=>i(e,`❌ Ошибка получения профиля. Код: ${e.status}`))),fetch(`${c.baseUrl}/cards`,{headers:c.headers}).then((e=>i(e,`❌ Ошибка получения карточек. Код: ${e.status}`)))]).then((t=>{let[r,o]=t;L.textContent=r.name,g.textContent=r.about,k.style["background-image"]=`url(${r.avatar})`,j.profileId=r._id,o.forEach((t=>{d.append(e(t,j))}))})).catch((e=>{"string"==typeof e&&e.startsWith("❌")||(e="Ошибка начальной загрузки");const r=document.querySelector(".popup_type_error");r.querySelector(".popup__title").textContent=e,r.querySelector(".popup__button").addEventListener("click",(()=>{window.location.reload()})),t(r)}))})();