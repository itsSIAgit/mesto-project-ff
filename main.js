(()=>{"use strict";function e(e,t){const r=t.cardTemplate.querySelector(".card").cloneNode("true"),o=r.querySelector(".card__image"),n=r.querySelector(".card__like-button"),a=r.querySelector(".card__like-counter");return o.src=e.link,o.alt=e.name,r.id=e._id,a.textContent=e.likes.length,r.querySelector(".card__title").textContent=e.name,t.profileId===e.owner._id?r.querySelector(".card__delete-button").addEventListener("click",(()=>{t.eraseCard(r.id)})):r.querySelector(".card__delete-button").classList.add("card__delete-button_disabled"),e.likes.some((e=>e._id===t.profileId))&&n.classList.add("card__like-button_is-active"),n.addEventListener("click",(e=>{t.checkLikeCard(e,r.id,a)})),o.addEventListener("click",t.openLargeImage),r}function t(e){e.classList.add("popup_is-animated"),setTimeout((()=>{e.classList.add("popup_is-opened")}),50),document.addEventListener("keydown",o)}function r(e){e.classList.remove("popup_is-opened"),setTimeout((()=>{e.classList.remove("popup_is-animated")}),600),document.removeEventListener("keydown",o)}function o(e){"Escape"===e.key&&r(document.querySelector(".popup_is-opened"))}function n(e,t,r){a(t,r,function(e){return e.some((e=>!e.validity.valid))}(e))}function a(e,t,r){e.classList.toggle(t,r),e.disabled=r}function s(e,t,r,o){const n=e.querySelector(`.popup__error_input-error_${t.id}`);t.classList.remove(r),n.classList.remove(o),n.textContent=""}function c(e,t){const r=Array.from(e.querySelectorAll(t.inputSelector)),o=e.querySelector(t.submitButtonSelector);r.forEach((r=>{s(e,r,t.inputErrorClass,t.errorClass)})),a(o,t.inactiveButtonClass,!0)}const i={baseUrl:"https://mesto.nomoreparties.co/v1/wff-cohort-11",headers:{authorization:"34673cb7-5fe3-4323-9567-b98efa2f95b7","Content-Type":"application/json;charset=utf-8"}};function u(e,t){return e.ok?e.json():Promise.reject(t)}const l=e=>fetch(`${i.baseUrl}/cards/likes/${e}`,{method:"PUT",headers:i.headers}).then((e=>u(e,`❌ Ошибка записи лайка. Код: ${e.status}`))),d=e=>fetch(`${i.baseUrl}/cards/likes/${e}`,{method:"DELETE",headers:i.headers}).then((e=>u(e,`❌ Ошибка стирания лайка. Код: ${e.status}`))),p=document.querySelector(".places__list"),m=document.querySelector("#card-template").content,_=document.querySelectorAll(".popup"),f=document.querySelector(".popup_type_edit"),h=document.querySelector(".popup_type_new-card"),y=document.querySelector(".popup_type_image"),v=document.querySelector(".popup__image"),S=document.querySelector(".popup__caption"),b=document.querySelector(".popup_type_agree"),C=document.querySelector(".popup_type_new-avatar"),q=b.querySelector(".popup__button");let g;const L=document.querySelector(".profile__title"),k=document.querySelector(".profile__description"),E=document.querySelector(".profile__image"),x=document.forms["edit-profile"],$=x.elements.name,T=x.elements.description,w=x.querySelector(".popup__button"),A=document.forms["new-place"],U=A.elements["place-name"],B=A.elements.link,P=A.querySelector(".popup__button"),I=document.forms["new-avatar"],D=I.elements["ava-link"],j=I.querySelector(".popup__button"),N={cardTemplate:m,profileId:"",openLargeImage:function(e){v.src=e.target.src,v.alt=e.target.alt,S.textContent=e.target.closest(".card").querySelector(".card__title").textContent,t(y)},checkLikeCard:function(e,t,r,o){const n=e.target;(n.classList.contains("card__like-button_is-active")?d:l)(t).then((e=>{o=e.likes.length})).catch((()=>{o="ERROR"})).finally((()=>{!function(e,t,r){Number(r)===r&&e.classList.toggle("card__like-button_is-active"),t.textContent=r}(n,r,o)}))},eraseCard:function(e){g=e,t(b)}},O={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"};function H(e,t,r,o){"string"==typeof e&&e.startsWith("❌")||(e="❌ "+o),t.textContent=e,setTimeout((()=>{t.textContent=r}),5e3)}document.querySelector(".profile__edit-button").addEventListener("click",(()=>{$.value=L.textContent,T.value=k.textContent,c(x,O),t(f)})),document.querySelector(".profile__add-button").addEventListener("click",(()=>{t(h)})),document.querySelector(".profile__image").addEventListener("click",(()=>{t(C)})),_.forEach((e=>{e.addEventListener("mousedown",(t=>{(t.target.classList.contains("popup_is-opened")||t.target.classList.contains("popup__close"))&&r(e)}))})),x.addEventListener("submit",(function(e){var t,o;e.preventDefault(),w.textContent="Сохранение...",(t=$.value,o=T.value,fetch(`${i.baseUrl}/users/me`,{method:"PATCH",headers:i.headers,body:JSON.stringify({name:t,about:o})}).then((e=>u(e,`❌ Ошибка отправки. Код: ${e.status}`)))).then((e=>{L.textContent=e.name,k.textContent=e.about,r(f),setTimeout((()=>{w.textContent="Сохранить"}),1e3)})).catch((e=>{H(e,w,"Сохранить","Ошибка отправки")}))})),A.addEventListener("submit",(function(t){var o,n;t.preventDefault(),P.textContent="Сохранение...",(o=U.value,n=B.value,fetch(`${i.baseUrl}/cards`,{method:"POST",headers:i.headers,body:JSON.stringify({name:o,link:n})}).then((e=>u(e,`❌ Ошибка отправки. Код: ${e.status}`)))).then((t=>{p.prepend(e(t,N)),r(h),setTimeout((()=>{P.textContent="Сохранить"}),1e3),A.reset(),c(A,O)})).catch((e=>{H(e,P,"Сохранить","Ошибка отправки")}))})),I.addEventListener("submit",(function(e){var t;e.preventDefault(),j.textContent="Сохранение...",(t=D.value,fetch(t,{method:"HEAD"}).then((e=>e.ok?!!e.headers.get("Content-Type").includes("image"):Promise.reject(`❌ Картинка недоступна. Код: ${e.status}`)))).then((e=>{if(!e)return Promise.reject("❌ По ссылке не картинка");(e=>fetch(`${i.baseUrl}/users/me/avatar`,{method:"PATCH",headers:i.headers,body:JSON.stringify({avatar:e})}).then((e=>u(e,`❌ Ошибка отправки. Код: ${e.status}`))))(D.value).then((e=>{E.style["background-image"]=`url(${e.avatar})`,r(C),setTimeout((()=>{j.textContent="Сохранить"}),1e3),I.reset(),c(I,O)}))})).catch((e=>{H(e,j,"Сохранить","Картинка недоступна или плохая")}))})),q.addEventListener("click",(()=>{var e;q.textContent="Удаление...",(e=g,fetch(`${i.baseUrl}/cards/${e}`,{method:"DELETE",headers:i.headers}).then((e=>u(e,`❌ Ошибка удаления. Код: ${e.status}`)))).then((()=>{!function(e){document.getElementById(e).remove()}(g),r(b),setTimeout((()=>{q.textContent="Да"}),1e3)})).catch((e=>{H(e,q,"Да","Ошибка удаления")}))})),function(e){Array.from(document.querySelectorAll(e.formSelector)).forEach((t=>{!function(e,t){const r=Array.from(e.querySelectorAll(t.inputSelector)),o=e.querySelector(t.submitButtonSelector);n(r,o,t.inactiveButtonClass),r.forEach((a=>{a.addEventListener("input",(()=>{!function(e,t,r,o){t.validity.patternMismatch?t.setCustomValidity(t.dataset.errorMessage):t.setCustomValidity(""),t.validity.valid?s(e,t,r,o):function(e,t,r,o,n){const a=e.querySelector(`.popup__error_input-error_${t.id}`);t.classList.add(r),a.textContent=n,a.classList.add(o)}(e,t,r,o,t.validationMessage)}(e,a,t.inputErrorClass,t.errorClass),n(r,o,t.inactiveButtonClass)}))}))}(t,e)}))}(O),Promise.all([fetch(`${i.baseUrl}/users/me`,{headers:i.headers}).then((e=>u(e,`❌ Ошибка получения профиля. Код: ${e.status}`))),fetch(`${i.baseUrl}/cards`,{headers:i.headers}).then((e=>u(e,`❌ Ошибка получения карточек. Код: ${e.status}`)))]).then((t=>{let[r,o]=t;L.textContent=r.name,k.textContent=r.about,E.style["background-image"]=`url(${r.avatar})`,N.profileId=r._id,o.forEach((t=>{p.append(e(t,N))}))})).catch((e=>{"string"==typeof e&&e.startsWith("❌")||(e="Ошибка начальной загрузки");const r=document.querySelector(".popup_type_error");r.querySelector(".popup__title").textContent=e,r.querySelector(".popup__button").addEventListener("click",(()=>{window.location.reload()})),t(r)}))})();